(this.webpackJsonpclient=this.webpackJsonpclient||[]).push([[0],{17:function(e,t,o){e.exports=o(35)},26:function(e,t,o){},27:function(e,t,o){},35:function(e,t,o){"use strict";o.r(t);var n=o(0),r=o.n(n),a=o(12),s=o.n(a),l=(o(26),o(27),o(5));let i=!1;new Set;async function c(e,t){let o=arguments.length>2&&void 0!==arguments[2]?arguments[2]:3,n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:1e4;for(let l=0;l<o;l++)try{var r,a;const o=await fetch(e,t);if(o.ok)return await o.json();const s=await o.json();if("PERMISSION_DENIED"!==(null===(r=s.error)||void 0===r?void 0:r.status)||!(null===(a=s.error)||void 0===a?void 0:a.message.includes("Quota exceeded")))return console.error("API request failed:",s),null;console.warn(`Quota exceeded. Retrying in ${n/1e3} seconds...`),await new Promise(e=>setTimeout(e,n))}catch(s){console.error("Network error during fetch:",s),await new Promise(e=>setTimeout(e,n))}return console.error("Max retries reached. API request failed."),null}async function d(){try{console.log("\ud83d\udd04 Refreshing access token...");const e=await fetch("http://localhost:5001/api/refresh-token",{method:"POST",headers:{"Content-Type":"application/json"}});if(!e.ok)throw new Error("HTTP error! Status: "+e.status);const t=await e.json();if(t.access_token)return console.log("\u2705 New Access Token:",t.access_token),localStorage.setItem("accessToken",t.access_token),localStorage.setItem("tokenExpiry",(Date.now()+1e3*t.expires_in).toString()),t.access_token;throw new Error("No access token returned")}catch(e){return console.error("\u274c Failed to refresh token:",e),null}}async function u(){let e=localStorage.getItem("accessToken"),t=localStorage.getItem("refreshToken"),o=parseInt(localStorage.getItem("tokenExpiry"),10)||0,n=Date.now();if(e&&n<o)return console.log("\u2705 Using stored access token."),e;if(!t)return console.error("\u274c No refresh token available. User must log in."),null;console.warn("\u26a0\ufe0f Token expired. Refreshing...");try{const e=await fetch("https://warrentycalender.vanirinstalledsales.info/api/refresh-token",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({refresh_token:t})});if(!e.ok)throw new Error("Failed to refresh token");const o=await e.json();return o.access_token?(localStorage.setItem("accessToken",o.access_token),localStorage.setItem("tokenExpiry",Date.now()+1e3*o.expires_in),console.log("\u2705 New Access Token:",o.access_token),o.access_token):(console.error("\u274c No new access token received. User must log in again."),null)}catch(r){return console.error("\u274c Error refreshing access token:",r),null}}async function g(e,t,o){if(o&&o.provider_token||(console.error("\u274c No valid session token found. Attempting to refresh..."),o={provider_token:await u()}),!o.provider_token)return console.error("\u274c Still no valid access token after refresh. Aborting event creation."),null;console.log("\ud83d\udd11 Using Access Token in Script:",o.provider_token);const n=`https://www.googleapis.com/calendar/v3/calendars/${t}/events`,r={summary:e.title,description:e.description||"No description provided",start:{dateTime:new Date(e.start).toISOString(),timeZone:"America/Toronto"},end:{dateTime:new Date(e.end).toISOString(),timeZone:"America/Toronto"},location:e.location||"No location provided"};try{const t=await fetch(n,{method:"POST",headers:{Authorization:"Bearer "+o.provider_token,"Content-Type":"application/json"},body:JSON.stringify(r)}),a=await t.json();return t.ok?(console.log(`\u2705 Event created successfully: "${e.title}" (ID: ${a.id})`),a.id):(console.error("\u274c Error creating Google Calendar event:",a),null)}catch(a){return console.error("\u274c Failed to create event:",a),null}}async function f(e,t,o,n){if(!o)return void console.log(`No changes found for record ${e}. Skipping update.`);console.log(`Updating Airtable record ${e} with Google Event ID: ${t}, marking as processed, and adding Calendar Link`);const r="https://api.airtable.com/v0/appO21PVRA4Qa087I/tbl6EeKPsNuEvt5yJ/"+e,a={fields:{GoogleEventId:t,Processed:!0,CalendarLink:n,LastUpdated:(new Date).toISOString()}};try{const e=await fetch(r,{method:"PATCH",headers:{Authorization:"Bearer patXTUS9m8os14OO1.6a81b7bc4dd88871072fe71f28b568070cc79035bc988de3d4228d52239c8238","Content-Type":"application/json"},body:JSON.stringify(a)}),t=await e.json();e.ok?console.log("Airtable record successfully updated:",t):console.error("Error updating Airtable:",t.error)}catch(s){console.error("Error updating Airtable:",s)}}async function p(){if(i)return console.log("Script is terminated. Skipping fetch for unprocessed events."),[];console.log("Fetching unprocessed events from Airtable...");const e=new Date;e.setHours(0,0,0,0);const t=e.toISOString().split("T")[0],o=`https://api.airtable.com/v0/appO21PVRA4Qa087I/tbl6EeKPsNuEvt5yJ?filterByFormula=OR(IS_AFTER({FormattedStartDate}, '${t}'), {FormattedStartDate}='${t}')`;try{const e={headers:{Authorization:"Bearer patXTUS9m8os14OO1.6a81b7bc4dd88871072fe71f28b568070cc79035bc988de3d4228d52239c8238","Content-Type":"application/json"}},t=await c(o,e),n=t.records.map(e=>({id:e.id,title:e.fields["Lot Number and Community/Neighborhood"]||"No lot number",start:new Date(e.fields.FormattedStartDate),end:new Date(e.fields.FormattedEndDate),description:e.fields["Description of Issue"]||"",b:e.fields.b||"",processed:e.fields.Processed||!1,streetAddress:e.fields["Street Address"]||"",city:e.fields.City||"",state:e.fields.State||"",zipCode:e.fields["Zip Code"]||"",location:[e.fields["Street Address"],e.fields.City,e.fields.State,e.fields["Zip Code"]].filter(Boolean).join(", ")}));return console.log("\ud83d\ude80 Processed Airtable records:",n),console.log("Fetched raw Airtable data:",t.records),console.log("Fetched unprocessed records:",n),0===n.length&&(console.log("No unprocessed events found."),setTimeout(()=>{i=!1},6e4)),n}catch(n){return console.error("Error fetching Airtable events:",n),[]}}function h(e){return new Promise(t=>setTimeout(t,e))}async function m(e,t,o){const n=await fetch("http://localhost:5001/api/tokens");if(!n.ok)return console.error("Failed to fetch token"),!1;const r=(await n.json()).access_token,a=`https://www.googleapis.com/calendar/v3/calendars/${t}/events/${e}`;try{const t=await fetch(a,{method:"DELETE",headers:{Authorization:"Bearer "+r,"Content-Type":"application/json"}});if(!t.ok){const e=await t.json();return console.error("Failed to delete Google Calendar event:",e),!1}return console.log("Google Calendar event deleted successfully:",e),!0}catch(s){return console.error("Error deleting Google Calendar event:",s),!1}}async function v(e,t){if(i)console.log("\ud83d\uded1 Script is terminated. Skipping duplicate removal.");else{console.log(`Checking for duplicate events in calendar: ${e}...`);try{const t=await async function(e){console.log("\ud83d\udcc5 Fetching events for Google Calendar: "+e);try{var t;let o=await u();if(o||(console.error("\u274c No valid access token available. Attempting to refresh..."),o=await d()),!o)return void console.error("\u274c Still no valid access token after refresh. Aborting.");console.log("\ud83d\udd11 Using Access Token:",o);const n=`https://www.googleapis.com/calendar/v3/calendars/${e}/events?timeMin=${(new Date).toISOString()}&maxResults=250&orderBy=startTime&singleEvents=true`;console.log("\ud83c\udf0d Calling Google Calendar API: "+n);const r=await fetch(n,{method:"GET",headers:{Authorization:"Bearer "+o}});if(!r.ok){const e=await r.json();return console.error("\u274c Failed to fetch Google Calendar events:",e),[]}const a=await r.json();return console.log(`\u2705 Successfully fetched ${(null===(t=a.items)||void 0===t?void 0:t.length)||0} events.`),a.items||[]}catch(o){return console.error("\u274c Error fetching Google Calendar events:",o),[]}}(e);if(i)return void console.log("\ud83d\uded1 Script was terminated after fetching events. Stopping processing.");if(!t||0===t.length)return void console.log("No events found in calendar.");const o=new Map,n=[];t.forEach(e=>{if(i)return void console.log("\ud83d\uded1 Termination detected during duplicate search.");const t=`${e.summary.toLowerCase().trim()}_${new Date(e.start.dateTime||e.start.date).toISOString()}`;o.has(t)?n.push(e):o.set(t,e)});for(const r of n){if(i)return void console.log("\ud83d\uded1 Termination detected. Stopping deletion process.");await m(r.id,e),console.log(`\ud83d\uddd1\ufe0f Deleted duplicate event: ${r.summary} (ID: ${r.id})`)}}catch(o){console.error(`Error removing duplicate events for calendar ID "${e}":`,o)}}}"undefined"!==typeof i&&i&&console.log("Script is terminated. Skipping further actions.");var w=function(){const e={Savannah:"c_ebe1fcbce1be361c641591a6c389d4311df7a97961af0020c889686ae059d20a@group.calendar.google.com",Charleston:"c_d113e252e0e5c8cfbf17a13149707a30d3c0fbeeff1baaac7a46940c2cc448ca@group.calendar.google.com",Greensboro:"c_03867438b82e5dfd8d4d3b6096c8eb1c715425fa012054cc95f8dea7ef41c79b@group.calendar.google.com",MyrtleBeach:"c_ad562073f4db2c47279af5aa40e53fc2641b12ad2497ccd925feb220a0f1abee@group.calendar.google.com",Wilmington:"c_45db4e963c3363676038697855d7aacfd1075da441f9308e44714768d4a4f8de@group.calendar.google.com",Grenville:"c_0476130ac741b9c58b404c737a8068a8b1b06ba1de2a84cff08c5d15ced54edf@group.calendar.google.com",Columbia:"c_df033dd6c81bb3cbb5c6fdfd58dd2931e145e061b8a04ea0c13c79963cb6d515@group.calendar.google.com",Raleigh:"warranty@vanirinstalledsales.com"};Object(n.useEffect)(()=>{const e=async()=>{let e=parseInt(localStorage.getItem("tokenExpiry"),10)||0,t=Date.now();!e||t>=e?(console.warn("\u26a0\ufe0f Token expired or missing. Refreshing..."),await u()):console.log("\u2705 Token is still valid.")};e();const t=setInterval(e,33e5);return()=>clearInterval(t)},[]);const t=Object(l.useSupabaseClient)(),o=Object(l.useSession)(),[a,s]=Object(n.useState)(function(){const e=new Date,t=new Date(e);return t.setMinutes(10*Math.ceil(e.getMinutes()/10),0,0),t<=e&&t.setMinutes(t.getMinutes()+10),Math.max(0,Math.floor((t-e)/1e3))}()),[i,c]=Object(n.useState)(Object.fromEntries(Object.entries(e).map(e=>{let[t]=e;return[t,{added:[],failed:[],noChange:[]}]})));function m(e,t){const o=e.title!==t.summary,n=new Date(e.start).toISOString()!==t.start.dateTime,r=new Date(e.end).toISOString()!==t.end.dateTime,a=(e.description||"")!==(t.description||""),s=(e.location||"")!==(t.location||"");return o||n||r||a||s}async function w(e){let t=await u();if(!t)return console.error("\u274c No valid access token available. Aborting fetch."),[];console.log("\ud83d\udcc5 Fetching Google Calendar events with token:",t);try{const o=await fetch(`https://www.googleapis.com/calendar/v3/calendars/${e}/events?timeMin=${(new Date).toISOString()}&maxResults=250&orderBy=startTime&singleEvents=true`,{method:"GET",headers:{Authorization:"Bearer "+t,"Content-Type":"application/json"}});if(!o.ok){const t=await o.json();if(401===t.error.code){console.warn("\ud83d\udd04 Access token expired. Attempting to refresh...");return await d()?(console.log("\ud83d\udd04 Retrying event fetch with new token..."),await w(e)):(console.error("\u274c Failed to refresh token. User may need to re-authenticate."),[])}throw console.error("\u274c Google Calendar API Error:",t),new Error(t.error.message)}const n=await o.json();return console.log(`\u2705 Successfully fetched ${n.items.length} events.`),n.items||[]}catch(o){return console.error("\u274c Failed to fetch Google Calendar events:",o.message),[]}}async function k(e,t,o,n,r){try{var a,s,l,i,c;const d=await u();if(!d)return void console.error("\u274c No valid access token available.");const g=`https://www.googleapis.com/calendar/v3/calendars/${r}/events/${e}`,f=await fetch(g,{method:"GET",headers:{Authorization:"Bearer "+d,"Content-Type":"application/json"}});if(!f.ok)return void console.error("\u274c Failed to fetch original Google Calendar event.");const p=await f.json(),h=(null===(a=p.start)||void 0===a?void 0:a.dateTime)||(null===(s=p.start)||void 0===s?void 0:s.date),m=(null===(l=p.end)||void 0===l?void 0:l.dateTime)||(null===(i=p.end)||void 0===i?void 0:i.date),v=(null===(c=p.start)||void 0===c?void 0:c.timeZone)||"America/New_York",w=e=>e?new Date(e).toISOString():null,k=w(h),y=w(m),S=w(o),b=w(n);if(console.log("\ud83d\udd35 Original Event (Before Update):",{summary:p.summary,start:k,end:y,timeZone:v}),console.log("\ud83d\udfe1 Updated Event Data (Before Sending):",{summary:t,start:S,end:b,timeZone:v}),S===k&&b===y)return void console.log("\u2705 No changes detected. Skipping update.");console.log("\u26a0\ufe0f Change detected. Updating event...");const E={summary:t,start:{dateTime:S,timeZone:v},end:{dateTime:b,timeZone:v}},I={method:"PATCH",headers:{Authorization:"Bearer "+d,"Content-Type":"application/json"},body:JSON.stringify(E)};if(!await async function(e,t){let o=arguments.length>2&&void 0!==arguments[2]?arguments[2]:3,n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:2e3;for(let a=1;a<=o;a++)try{const r=await fetch(e,t);if(r.ok)return r;if(console.warn(`\u26a0\ufe0f API call failed (Attempt ${a}/${o}): ${r.statusText}`),429!==r.status)return null;console.log("\u23f3 Rate limit hit. Retrying after delay..."),await new Promise(e=>setTimeout(e,n))}catch(r){console.error("\u274c API request error:",r)}return null}(g,I))return void console.error("\u274c Failed to update Google Calendar event after retries.");console.log("\u2705 Successfully updated event: "+t)}catch(d){console.error("\u274c Error updating Google Calendar event:",d)}}async function y(){try{console.log("\ud83d\ude80 Fetching and processing events for all calendars...");let n=await u();if(!n)return void console.error("\u274c No valid access token available. Aborting.");let r={};for(const[o,a]of Object.entries(e)){console.log("\ud83d\udcc5 Processing events for calendar: "+o);try{const e=(await p()).filter(e=>{var t;return(null===(t=e.b)||void 0===t?void 0:t.toLowerCase().trim().replace(/\s+/g,""))===o.toLowerCase().trim()});if(0===e.length){console.log(`\u2705 No unprocessed events found for ${o}. Skipping.`);continue}console.log(`\ud83d\udcca Filtered ${e.length} events from Airtable for calendar: ${o}`);const t=await w(a);console.log(`\ud83d\udcca Fetched ${t.length} events from Google Calendar: ${o}`);const s=new Map;t.forEach(e=>{var t;s.set(null===(t=e.summary)||void 0===t?void 0:t.toLowerCase().trim(),e)});let l=[];for(const o of e){if(!o.start||!o.end){console.error(`\u274c Skipping event "${o.title}" due to missing start or end date.`);continue}const e=o.title.toLowerCase().trim(),t=s.get(e);if(t)m(o,t)?(console.log("\ud83d\udd04 Updating event: "+o.title),await k(t.id,o.title,o.start,o.end,a)):console.log(`\u2705 No changes detected for event: ${o.title}, skipping update.`);else{console.log("\ud83c\udd95 Creating new event: "+o.title);const e=await g(o,a,n);e&&(await f(o.id,e,!0),console.log("\u2705 New event created and linked: "+o.title),l.push({title:o.title,start:o.start,end:o.end}))}}r[o]={added:l},console.log("\u2705 Finished processing events for calendar: "+o),await h(5e3)}catch(t){console.error(`\u274c Error processing events for calendar "${o}":`,t)}}for(const t of Object.values(e))try{await v(t)}catch(o){console.error(`\u274c Error removing duplicate events for calendar ID "${t}":`,o)}c(e=>({...e,...r})),console.log("\u2705 All events processed for all calendars.")}catch(o){console.error("\u274c Fatal error in fetchAndProcessEvents():",o)}}return Object(n.useEffect)(()=>{const e=()=>{const e=new Date,t=new Date(e);return t.setMinutes(10*Math.ceil(e.getMinutes()/10),0,0),t<=e&&t.setMinutes(t.getMinutes()+10),Math.max(0,Math.floor((t-e)/1e3))},t=setInterval(async()=>{const t=(new Date).getHours();if(t>=7&&t<=17){const t=e();if(s(t),0===t){if(console.log("\u23f3 Checking if token needs refresh..."),!await u())return void console.error("\u274c No valid token available. Skipping sync.");console.log("\ud83d\udd04 Running event sync..."),await y(),s(e())}}},1e3);return()=>clearInterval(t)},[o]),r.a.createElement("div",{className:"App"},r.a.createElement("h1",null,"Google Calendar Sync"),r.a.createElement("p",null,"Next sync in: ",function(e){const t=Math.floor(e/60),o=e%60;return`${String(t).padStart(2,"0")}:${String(o).padStart(2,"0")}`}(a)),o?r.a.createElement("button",{onClick:async()=>{try{const{error:e}=await t.auth.refreshSession();e&&console.error("Error refreshing session:",e),await t.auth.signOut(),console.log("User logged out successfully.")}catch(e){console.error("Error during logout:",e)}}},"Logout"):r.a.createElement(r.a.Fragment,null,r.a.createElement("button",{onClick:async function(){try{const{data:e,error:o}=await t.auth.signInWithOAuth({provider:"google",options:{scopes:"https://www.googleapis.com/auth/calendar",redirectTo:"https://warrentycalender.vanirinstalledsales.info"}});if(o)throw o;console.log("\u2705 Supabase Login Started:",e);const{data:n}=await t.auth.getSession();(null===n||void 0===n?void 0:n.session)?(console.log("\u2705 Supabase Session Received:",n.session),async function(e){if(console.log("\ud83d\udd11 Tokens received:",e),!(null===e||void 0===e?void 0:e.provider_token))return void console.error("\u274c No access token found.");const t={access_token:e.provider_token,refresh_token:e.refresh_token||localStorage.getItem("refreshToken"),expires_in:e.expires_in||3600,token_type:"Bearer"};await async function(e){try{if(!(await fetch("http://localhost:5001/save-tokens",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)})).ok)throw new Error("Failed to save tokens");console.log("\u2705 Tokens successfully sent to the backend.")}catch(o){console.error("\u274c Error saving tokens:",o)}}(t),localStorage.setItem("accessToken",t.access_token),localStorage.setItem("refreshToken",t.refresh_token),localStorage.setItem("tokenExpiry",Date.now()+1e3*t.expires_in)}(n.session)):console.error("\u274c Supabase session not found after login.")}catch(e){console.error("\u274c Error during login:",e)}}},"Sign in with Google"),r.a.createElement("button",{onClick:y},"Sync Now")),o&&r.a.createElement(r.a.Fragment,null,r.a.createElement("button",{onClick:y},"Sync Now"),r.a.createElement("div",{style:{display:"grid",gridTemplateColumns:"repeat(4, 1fr)",gap:"20px"}},Object.entries(i).map(e=>{let[t,o]=e;const n=(null===o||void 0===o?void 0:o.added)||[],a=(null===o||void 0===o?void 0:o.updated)||[];return r.a.createElement("div",{key:t,className:"calendar-section"},r.a.createElement("h2",null,t),n.length>0&&r.a.createElement(r.a.Fragment,null,r.a.createElement("h3",null,"New Events"),r.a.createElement("ul",null,n.map((e,t)=>{const o=e.start?new Date(e.start).toLocaleString():"Invalid Date",n=e.end?new Date(e.end).toLocaleString():"Invalid Date";return r.a.createElement("li",{key:t},r.a.createElement("strong",null,e.title)," ",r.a.createElement("br",null),r.a.createElement("span",null,"Start: ",isNaN(new Date(e.start))?"Invalid Date":o)," ",r.a.createElement("br",null),r.a.createElement("span",null,"End: ",isNaN(new Date(e.end))?"Invalid Date":n))}))),a.length>0&&r.a.createElement(r.a.Fragment,null,r.a.createElement("h3",null,"Updated Events"),r.a.createElement("ul",null,a.map((e,t)=>{const o=e.start?new Date(e.start).toLocaleString():"Invalid Date",n=e.end?new Date(e.end).toLocaleString():"Invalid Date";return r.a.createElement("li",{key:t},r.a.createElement("strong",null,e.title)," ",r.a.createElement("br",null),r.a.createElement("span",null,"Start: ",isNaN(new Date(e.start))?"Invalid Date":o)," ",r.a.createElement("br",null),r.a.createElement("span",null,"End: ",isNaN(new Date(e.end))?"Invalid Date":n))}))),0===n.length&&0===a.length&&r.a.createElement("p",null,"No new or updated events."))}))))};var k=e=>{e&&e instanceof Function&&o.e(3).then(o.bind(null,37)).then(t=>{let{getCLS:o,getFID:n,getFCP:r,getLCP:a,getTTFB:s}=t;o(e),n(e),r(e),a(e),s(e)})},y=o(15);const S=Object(y.a)("https://uesmvtbhivtxfazdhoed.supabase.co","eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVlc212dGJoaXZ0eGZhemRob2VkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MjM3MjY5MDEsImV4cCI6MjAzOTMwMjkwMX0.ypk6eicENjyrdsCm-OLbiiaJAHMfx5gmQQ3XuYBLrys");s.a.createRoot(document.getElementById("root")).render(r.a.createElement(r.a.StrictMode,null,r.a.createElement(l.SessionContextProvider,{supabaseClient:S},r.a.createElement(w,null)))),k()}},[[17,1,2]]]);
//# sourceMappingURL=main.884dec18.chunk.js.map